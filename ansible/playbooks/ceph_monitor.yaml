- name: generate uuid
  tags: ceph_monitor
  shell: uuidgen
  register: uuid

- name: generate cepth configurati  on
  tags: ceph_monitor
  shell: |
    echo "" > /etc/ceph/ceph.conf 
    tee -a /etc/ceph/ceph.conf << EOF
    [global]
    # specify cluster network for monitoring
    cluster network = {{ ceph_cluster_network_cidr }}
    # specify public network
    public network = {{ ceph_cluster_network_cidr }}
    # specify UUID genarated above
    fsid = {{ item.uuid }}
    # specify IP address of Monitor Daemon
    mon host = {{ item.private_ip }}
    # specify Hostname of Monitor Daemon
    mon initial members = {{ item.instance_name }}
    osd pool default crush rule = -1
    
    # mon.(Node name)
    [mon.{{ item.instance_name }}]
    # specify Hostname of Monitor Daemon
    host = {{ item.instance_name }}
    # specify IP address of Monitor Daemon
    mon addr = {{ item.private_ip }}
    # allow to delete pools
    mon allow pool delete = true
    EOF
    chown ceph:ceph /etc/ceph/
    chown ceph:ceph /etc/ceph/*
  with_items: 
    - { uuid: "{{ uuid.stdout }}", 
        instance_name: "{{ hostvars[inventory_hostname].name }}", 
        private_ip: "{{ hostvars[inventory_hostname].networkInterfaces[0].networkIP }}"
      }
    #- "{{ hostvars[inventory_hostname].disks }}" # disks mountd
- name: genarate secret key for cluster moniotring and bootstrap
  tags: ceph_monitor
  shell: |
    ceph-authtool --create-keyring /etc/ceph/ceph.mon.keyring --gen-key -n mon. --cap mon 'allow *'
    ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --cap mon 'allow *' --cap osd 'allow *' --cap mds 'allow *' --cap mgr 'allow *'
    ceph-authtool --create-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring --gen-key -n client.bootstrap-osd --cap mon 'profile bootstrap-osd' --cap mgr 'allow r'
- name: import keys
  tags: ceph_monitor
  shell: | 
    ceph-authtool /etc/ceph/ceph.mon.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring
    ceph-authtool /etc/ceph/ceph.mon.keyring --import-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring
- name: generate monitor map
  tags: ceph_monitor
  shell: monmaptool --create --add {{ item.instance_name }} {{ item.private_ip }} --fsid {{ item.uuid }} /etc/ceph/monmap
  with_items: 
    - { uuid: "{{ uuid.stdout }}", 
        instance_name: "{{ hostvars[inventory_hostname].name }}", 
        private_ip: "{{ hostvars[inventory_hostname].networkInterfaces[0].networkIP }}"
      }
      
- name: setup monitor deamon
  tags: ceph_monitor
  shell: |
    mkdir /var/lib/ceph/mon/ceph-{{ item }}
    ceph-mon --cluster ceph --mkfs -i {{ item }} --monmap /etc/ceph/monmap --keyring /etc/ceph/ceph.mon.keyring
    chown ceph. /etc/ceph/ceph.*
    chown -R ceph. /var/lib/ceph/mon/ceph-{{ item }} /var/lib/ceph/bootstrap-osd
  with_items: "{{ hostvars[inventory_hostname].name }}"
- name: enable and start monitor service
  tags: ceph_monitor
  shell: |
    systemctl enable --now ceph-mon@{{ item }}
    systemctl start ceph-mon@{{ item }}
  with_items: "{{ hostvars[inventory_hostname].name }}"
- name: enable monitor protocol
  tags: ceph_monitor
  shell: |
    ceph mon enable-msgr2
    ceph config set mon auth_allow_insecure_global_id_reclaim false